<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ATP Platform Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true, theme:'default'});</script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 40px; }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .description {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ATP Platform Architecture</h1>

    <div class="description">
        <strong>ATP (Agent Test Platform)</strong> - framework-agnostic platform for testing AI agents.
        Core principle: Agent = black box with contract (input â†’ output + events).
    </div>

    <h2>Main Data Flow</h2>
    <pre class="mermaid">
flowchart TD
    subgraph Input
        YAML[Test Suite YAML]
    end

    subgraph Loader
        TL[TestLoader]
        TS[TestSuite]
    end

    subgraph Runner
        TO[TestOrchestrator]
        SM[SandboxManager]
    end

    subgraph Adapters
        AR[AdapterRegistry]
        HTTP[HTTPAdapter]
        CLI[CLIAdapter]
        Docker[ContainerAdapter]
        LG[LangGraphAdapter]
        Crew[CrewAIAdapter]
    end

    subgraph Agent
        AG((Agent<br/>Black Box))
    end

    subgraph Protocol
        REQ[ATPRequest]
        RES[ATPResponse]
        EVT[ATPEvents]
    end

    subgraph Evaluation
        ER[EvaluatorRegistry]
        AE[ArtifactEvaluator]
        BE[BehaviorEvaluator]
        CE[CodeExecEvaluator]
        LJ[LLMJudgeEvaluator]
    end

    subgraph Scoring
        SA[ScoreAggregator]
        SC[StatisticsCalculator]
    end

    subgraph Output
        RR[ReporterRegistry]
        CON[ConsoleReporter]
        JSON[JSONReporter]
        HTML[HTMLReporter]
        JUNIT[JUnitReporter]
    end

    YAML --> TL --> TS --> TO
    TO --> SM
    TO --> AR
    AR --> HTTP & CLI & Docker & LG & Crew
    HTTP & CLI & Docker & LG & Crew --> REQ --> AG
    AG --> RES & EVT
    RES & EVT --> ER
    ER --> AE & BE & CE & LJ
    AE & BE & CE & LJ --> SA --> SC
    SC --> RR
    RR --> CON & JSON & HTML & JUNIT
    </pre>

    <h2>Component Architecture</h2>
    <pre class="mermaid">
flowchart LR
    subgraph CLI["CLI (atp command)"]
        test[atp test]
        validate[atp validate]
        baseline[atp baseline]
        dashboard[atp dashboard]
    end

    subgraph Core["Core Modules"]
        protocol[Protocol<br/>Request/Response/Event]
        loader[Loader<br/>YAML Parser]
        runner[Runner<br/>Orchestrator]
        adapters[Adapters<br/>Agent Interface]
        evaluators[Evaluators<br/>Assertions]
        scoring[Scoring<br/>Aggregation]
        reporters[Reporters<br/>Output Format]
    end

    subgraph Storage["Data Layer"]
        baseline_store[Baseline Storage]
        db[(Dashboard DB)]
    end

    test --> loader --> runner --> adapters
    adapters --> protocol
    runner --> evaluators --> scoring --> reporters
    baseline --> baseline_store
    dashboard --> db
    </pre>

    <h2>ATP Protocol Messages</h2>
    <pre class="mermaid">
classDiagram
    class ATPRequest {
        +Task task
        +Constraints constraints
        +Context context
        +Dict metadata
    }

    class Task {
        +str description
        +Dict input_data
        +List expected_artifacts
    }

    class Constraints {
        +int max_steps
        +int timeout_seconds
        +List allowed_tools
        +int max_cost_cents
    }

    class ATPResponse {
        +str version
        +str task_id
        +str status
        +List~Artifact~ artifacts
        +Metrics metrics
        +str error
    }

    class Artifact {
        +str type
        +str path
        +str content
        +str content_type
    }

    class ATPEvent {
        +int sequence
        +str timestamp
        +str event_type
        +Dict payload
    }

    ATPRequest --> Task
    ATPRequest --> Constraints
    ATPResponse --> Artifact
    ATPResponse --> Metrics
    </pre>

    <h2>Test Execution Sequence</h2>
    <pre class="mermaid">
sequenceDiagram
    participant User
    participant CLI
    participant Loader
    participant Orchestrator
    participant Adapter
    participant Agent
    participant Evaluator
    participant Reporter

    User->>CLI: atp test suite.yaml
    CLI->>Loader: Load test suite
    Loader-->>CLI: TestSuite
    CLI->>Orchestrator: Execute tests

    loop For each test
        Orchestrator->>Adapter: Create adapter
        Adapter->>Agent: ATPRequest
        Agent-->>Adapter: ATPResponse + Events
        Adapter-->>Orchestrator: RunResult
        Orchestrator->>Evaluator: Evaluate assertions
        Evaluator-->>Orchestrator: EvalResult
    end

    Orchestrator-->>CLI: SuiteResult
    CLI->>Reporter: Generate report
    Reporter-->>User: Console/JSON/HTML output
    </pre>

    <h2>Adapter Types</h2>
    <pre class="mermaid">
flowchart TD
    subgraph AgentAdapter["AgentAdapter (Base)"]
        execute[execute]
        stream[stream_events]
        health[health_check]
        cleanup[cleanup]
    end

    subgraph Implementations
        HTTP[HTTPAdapter<br/>REST API]
        CLI[CLIAdapter<br/>Command Line]
        Container[ContainerAdapter<br/>Docker]
        LangGraph[LangGraphAdapter<br/>LangGraph Framework]
        CrewAI[CrewAIAdapter<br/>CrewAI Framework]
        AutoGen[AutoGenAdapter<br/>AutoGen Framework]
    end

    AgentAdapter --> HTTP
    AgentAdapter --> CLI
    AgentAdapter --> Container
    AgentAdapter --> LangGraph
    AgentAdapter --> CrewAI
    AgentAdapter --> AutoGen
    </pre>

    <h2>Evaluator Types</h2>
    <pre class="mermaid">
flowchart LR
    subgraph Evaluators
        artifact[ArtifactEvaluator<br/>File existence, content]
        behavior[BehaviorEvaluator<br/>Tool calls, patterns]
        code[CodeExecEvaluator<br/>Custom validation]
        llm[LLMJudgeEvaluator<br/>Quality assessment]
    end

    subgraph Assertions
        A1[artifact_exists]
        A2[artifact_contains]
        A3[json_schema]
        A4[tool_called]
        A5[no_errors]
        A6[custom_code]
        A7[llm_quality]
    end

    A1 & A2 & A3 --> artifact
    A4 & A5 --> behavior
    A6 --> code
    A7 --> llm
    </pre>

</body>
</html>
